{{- if and (eq .chezmoi.os "linux") (eq .sysarea "work") -}}
#!/usr/bin/env bash
# My work laptop is a little rusty, and things like rust-analyzer and virus scanning will produce significant UI lag
# This script tells the CPU to be less enthusiastic about throttling
# Use the following command to verify it worked:
#
# grep . /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor /sys/devices/system/cpu/cpu0/cpufreq/energy_performance_preference 

# Define the rule content
RULE_CONTENT="# Generated by chezmoi
# Set the governor to performance
w /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor - - - - performance

# Set the hardware energy bias to performance
w /sys/devices/system/cpu/cpu*/cpufreq/energy_performance_preference - - - - performance"

TARGET_CONF="/etc/tmpfiles.d/cpu-governor.conf"

# Mask tuned as it is likely the one locking EPP on Bluefin/Fedora
sudo systemctl mask --now tuned || true

# Create a temporary file
TEMP_FILE=$(mktemp)
echo "$RULE_CONTENT" > "$TEMP_FILE"

# Apply to /etc
if [ ! -f "$TARGET_CONF" ] || ! cmp -s "$TEMP_FILE" "$TARGET_CONF"; then
    echo "Applying CPU Performance Governor to $TARGET_CONF..."
    sudo mkdir -p /etc/tmpfiles.d
    sudo mv "$TEMP_FILE" "$TARGET_CONF"
    sudo chmod 644 "$TARGET_CONF"
    
    # Apply the settings immediately
    # We use '|| true' because if one CPU core is busy, we want the rest to still update
    sudo systemd-tmpfiles --create "$TARGET_CONF" || true
else
    rm "$TEMP_FILE"
fi

# Manual fallback for the current session just in case tmpfiles had a partial "busy" error
echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor > /dev/null
echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/energy_performance_preference 2>/dev/null || echo "EPP busy, but governor set."
{{- end }}
