{{- if and (eq .chezmoi.os "linux") (eq .sysarea "work") -}}
#!/usr/bin/env bash

# Define the rule content
RULE_CONTENT="# Generated by chezmoi
# Type Path                                           Mode UID  GID  Age Argument
w     /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor -    -    -    -   performance"

TARGET_CONF="/etc/tmpfiles.d/cpu-governor.conf"

# Create a temporary file and write the content
TEMP_FILE=$(mktemp)
echo "$RULE_CONTENT" > "$TEMP_FILE"

# Check if the target is different before touching /etc
if [ ! -f "$TARGET_CONF" ] || ! cmp -s "$TEMP_FILE" "$TARGET_CONF"; then
    echo "Applying CPU Performance Governor to $TARGET_CONF..."
    sudo mkdir -p /etc/tmpfiles.d
    sudo mv "$TEMP_FILE" "$TARGET_CONF"
    sudo chmod 644 "$TARGET_CONF"
    
    # Apply the settings immediately to the kernel
    sudo systemd-tmpfiles --create "$TARGET_CONF"
else
    rm "$TEMP_FILE"
fi
{{- end }}
